# Session Handoff - 2026-02-01-14-35

## üéØ MISSION
Build comprehensive Net Revenue Retention (NRR) and GMV analysis views in BigQuery to support executive decision-making around customer concentration risk and retention strategy. Create customer-attributed views that track cohort retention over time.

## üìç CURRENT STATE
- **Phase**: Views created, one enhancement in progress
- **Just Completed**: Created 4 BigQuery views in `App_KPI_Dashboard` dataset
- **In Progress**: User asked to improve customer attribution for organizer fees using `class_name` field
- **Status**: Core functionality complete, enhancement requested

## ‚úÖ COMPLETED WORK

### BigQuery Views Created in `stitchdata-384118.App_KPI_Dashboard`:

1. **`cohort_retention_matrix_by_customer`** - Net Revenue cohort matrix
   - Shows DOLLARS + PERCENT sections
   - Net Revenue = Invoice - Credit Memos - Organizer Fees + Vendor Credits
   - Accounts 4000-4190 for revenue, 4200-4240 for organizer fees

2. **`net_revenue_retention_all_customers`** - Customer-level NRR tracker
   - Includes HubSpot target account flag, cohort year, account owner
   - NRR calculations by year (2022-2026)
   - Filters out suppliers and Professional Services

3. **`gmv_cohort_retention_matrix_by_customer`** - Gross GMV cohort matrix
   - Shows DOLLARS + PERCENT sections
   - Gross GMV = Invoice - Credit Memos (accounts 4000-4150)
   - Ties closely to P&L Gross GMV line

4. **`gmv_retention_tracker_by_customer`** - Customer-level GMV tracker
   - Includes HubSpot pipeline data, 2025 goals
   - YoY growth calculations
   - Forecast with pipeline

### SQL Files Updated:
- `/Users/deucethevenowworkm1/Projects/Sales Forecast/cohort_retention_matrix.sql`
- `/Users/deucethevenowworkm1/Projects/Sales Forecast/net_revenue_retention_all_customers.sql`

### Key Formula - Net Revenue (Direct GL Approach):
```
Invoice Line Amount (accounts 4000-4190)
+ Credit Memos (negative)
+ Organizer Fees/Bills (accounts 4200-4240, negative)
+ Vendor Credits (accounts 4200-4240, positive)
= NET REVENUE
```

## üìã TODO - Continue These Tasks
- [ ] **HIGH**: Improve customer attribution for organizer fees - user mentioned `class_name` can be used to join to customer name for bill lines without `account_expense_customer_id`
- [ ] **MED**: Investigate the ~11-13% of bill lines without customer_id to see if class_name can fill the gap
- [ ] **LOW**: Consider creating aggregate views that tie exactly to P&L (without customer attribution)

## üèóÔ∏è TECHNICAL DECISIONS

1. **Direct GL Approach**: Switched from remittance-based linking to direct account-based filtering
   - Organizer fees now use `bill_line.account_expense_customer_id` directly
   - Vendor credits use `vendor_credit_line.account_expense_customer_id` directly
   - This simplified the logic and improved accuracy

2. **Customer Attribution Gap**: ~11-13% of organizer fee bill lines don't have `account_expense_customer_id`
   - These unattributed costs (~$200-400K/year) excluded from customer-level views
   - Results in customer views showing ~5-10% higher than P&L
   - User suggested `class_name` might help fill this gap

3. **Account Ranges**:
   - Revenue: 4000-4190 (excludes 4250, 4260, 4300, 4310 per business decision)
   - Gross GMV: 4000-4150
   - Organizer Fees: 4200-4240

4. **Manual Customer Mapping**: Bayer (6660 ‚Üí 7069) handled via manual mapping since 6660 is deleted

## üîç KEY DISCOVERIES

1. **bill_line has direct customer attribution**: `account_expense_customer_id` field exists and is populated for ~88% of lines

2. **P&L Tie-out Results**:
   - Net Revenue 2024: Query $4,517,820 vs P&L $4,333,451 (+4%)
   - Net Revenue 2025: Query $4,197,795 vs P&L $3,911,537 (+7%)
   - Gross GMV ties very closely to P&L

3. **Class Name Hint**: User mentioned class_name has been used previously to join to customer name - this could help attribute the missing ~11-13% of organizer fees

## ‚ö†Ô∏è ISSUES & BLOCKERS

1. **Customer Attribution Gap**: 11-13% of bill lines lack customer_id
   - Workaround: Documented in view comments why totals don't match P&L exactly
   - Next step: Use `class_name` to improve attribution

2. **Quote escaping in BigQuery views**: Had to use `'"'"'` pattern for apostrophes in company names like "Nick's"

## üìÅ KEY FILES
```
/Users/deucethevenowworkm1/Projects/Sales Forecast/cohort_retention_matrix.sql - Net Revenue cohort matrix source
/Users/deucethevenowworkm1/Projects/Sales Forecast/net_revenue_retention_all_customers.sql - NRR all customers source
/Users/deucethevenowworkm1/Projects/Sales Forecast/target_customers_nrr_query.sql - Target accounts NRR query
/Users/deucethevenowworkm1/Projects/Sales Forecast/context/WORKING-2026-01-13-NRR-Analysis.md - Previous session context
```

## üîß ENVIRONMENT
- Working directory: `/Users/deucethevenowworkm1/Projects/Sales Forecast`
- BigQuery project: `stitchdata-384118`
- BigQuery dataset: `App_KPI_Dashboard`
- Required: `GOOGLE_APPLICATION_CREDENTIALS="/Users/deucethevenowworkm1/.config/bigquery-mcp-key.json"`
- Data sources: `src_fivetran_qbo.*`, `src_fivetran_hubspot.*`

## üí° NEXT SESSION SHOULD

1. **First action**: Investigate `class_name` field on `bill_line` table to see if it can be used to attribute organizer fees to customers
   ```sql
   SELECT class_name, COUNT(*), SUM(amount)
   FROM src_fivetran_qbo.bill_line
   WHERE account_expense_customer_id IS NULL
   GROUP BY 1
   ```

2. **Suggested approach**:
   - Check if class_name matches customer names or can be mapped
   - Update the organizer_fees CTE to use COALESCE with class-based customer lookup
   - Test if this improves the P&L tie-out

3. **Verify**: Check the bill_line schema for class-related fields

4. **Pitfall to avoid**: Don't break the existing customer attribution - add class-based lookup as a fallback only

## üìù CRITICAL VERBATIM CONTEXT

### Net Revenue Formula from P&L:
```
Net Revenue = 4100 (GMV) + 4190 (Discounts) + 4200 (Organizer Fees)
```

### Account Exclusions (per business decision):
- 4250: Shipping & Printing
- 4260: Digital Media
- 4300: Activation Services
- 4310: Platform Subscription

### P&L Expected Totals (for validation):
- 2024 Net Revenue: $4,333,451.22
- 2025 Net Revenue: $3,911,537.48
- 2024 Gross GMV: ~$7.8M
- 2025 Gross GMV: ~$7.9M

## üßµ CONVERSATION EVOLUTION
- **Original ask**: Continue NRR analysis work from previous session
- **Evolution**: Rewrote queries to use direct GL approach instead of remittance-based linking
- **Key user decisions**:
  - Store views in `App_KPI_Dashboard` dataset
  - Add "by_customer" suffix to view names
  - Include P&L variance explanation in query comments
  - Create both Net Revenue AND Gross GMV cohort matrices
- **Final request**: Use `class_name` to improve customer attribution for bill lines without customer_id
