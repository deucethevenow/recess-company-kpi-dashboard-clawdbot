# Session Handoff - 2026-02-01-15-45

## üéØ MISSION
Build comprehensive Net Revenue Retention (NRR) and GMV analysis views in BigQuery to support executive decision-making around customer concentration risk and retention strategy. Create customer-attributed views that track cohort retention over time with accurate P&L tie-out.

## üìç CURRENT STATE
- **Phase**: Complete - all views created and validated
- **Just Completed**: Saved both queries to company-kpi-dashboard/queries/customers/, provided full SQL to user
- **In Progress**: None - all tasks complete
- **Status**: Production-ready, variance accepted at ~0.5%

## ‚úÖ COMPLETED WORK

### BigQuery Views Updated in `stitchdata-384118.App_KPI_Dashboard`:
1. **`net_revenue_retention_all_customers`** - NRR tracker by customer
   - Includes HubSpot target account flag, cohort year, account owner
   - NRR calculations by year (2022-2026)
   - Customer attribution: DIRECT ‚Üí CLASS-BASED ‚Üí UNKNOWN bucket
   - Uses customer_year_spine for proper period attribution

2. **`cohort_retention_matrix_by_customer`** - Net Revenue cohort matrix
   - Shows DOLLARS + PERCENT sections
   - Net Revenue = Invoice - Credit Memos - Organizer Fees + Vendor Credits
   - Same spine fix applied for period attribution

### Files Created:
- `/Users/deucethevenowworkm1/Projects/company-kpi-dashboard/queries/customers/2026-02-01-net-revenue-retention-all-customers.sql`
- `/Users/deucethevenowworkm1/Projects/company-kpi-dashboard/queries/customers/2026-02-01-cohort-retention-matrix.sql`

### Files Updated:
- `/Users/deucethevenowworkm1/Projects/Sales Forecast/net_revenue_retention_all_customers.sql` - Added spine fix
- `/Users/deucethevenowworkm1/Projects/Sales Forecast/cohort_retention_matrix.sql` - Added spine fix

### Key Fix Implemented - customer_year_spine:
```sql
customer_year_spine AS (
    SELECT DISTINCT qbo_customer_id, revenue_year FROM invoice_by_customer_year WHERE qbo_customer_id != 'UNKNOWN'
    UNION DISTINCT
    SELECT DISTINCT qbo_customer_id, revenue_year FROM credit_memos WHERE qbo_customer_id != 'UNKNOWN'
    UNION DISTINCT
    SELECT DISTINCT qbo_customer_id, revenue_year FROM organizer_fees WHERE qbo_customer_id != 'UNKNOWN'
    UNION DISTINCT
    SELECT DISTINCT qbo_customer_id, revenue_year FROM vendor_credits WHERE qbo_customer_id != 'UNKNOWN'
),
```

## üìã TODO - Continue These Tasks
- [x] All requested tasks complete
- [ ] **LOW**: Consider creating GMV versions with same spine fix if needed
- [ ] **LOW**: Monitor variance over time as new transactions come in

## üèóÔ∏è TECHNICAL DECISIONS

1. **customer_year_spine approach**: Unions all customer/year combinations from ALL transaction types (invoices, credit memos, org fees, vendor credits) before joining. This ensures transactions appear in their correct period even when customer has no invoice in that year.

2. **Three-tier customer attribution**:
   - DIRECT: Use `account_expense_customer_id` when populated
   - CLASS-BASED: Fall back to `class_name` ‚Üí customer name matching
   - UNKNOWN: Bucket for truly unattributable transactions

3. **Account Ranges**:
   - Revenue: 4000-4190 (excludes 4250, 4260, 4300, 4310)
   - Organizer Fees: 4200-4240
   - Gross GMV: 4000-4150

4. **Variance Acceptance**: ~0.5% variance from P&L accepted as reasonable given customer attribution complexity

## üîç KEY DISCOVERIES

1. **Root cause of variance**: Orphaned transactions (credit memos, org fees, vendor credits for customers with invoices but NOT in the same year) were being lost due to LEFT JOIN from invoice_by_customer_year only.

2. **class_name helps attribution**: Using class_name as fallback improved customer attribution for bill lines without direct customer_id.

3. **P&L Tie-out Results (Final)**:
   - 2024: View $4,313,775 vs P&L $4,333,451 = **-0.45%**
   - 2025: View $3,905,119 vs P&L $3,911,537 = **-0.16%**

## ‚ö†Ô∏è ISSUES & BLOCKERS

1. **Remaining variance (~0.5%)**: Small amount of transactions still unattributable
   - Workaround: Documented in query headers, accepted as reasonable
   - UNKNOWN bucket captures ~$19K in 2024, ~$6K in 2025

2. **Quote escaping in BigQuery views**: Must use `'"'"'` pattern for apostrophes in company names

## üìÅ KEY FILES
```
/Users/deucethevenowworkm1/Projects/company-kpi-dashboard/queries/customers/2026-02-01-net-revenue-retention-all-customers.sql - NRR tracker query
/Users/deucethevenowworkm1/Projects/company-kpi-dashboard/queries/customers/2026-02-01-cohort-retention-matrix.sql - Cohort matrix query
/Users/deucethevenowworkm1/Projects/Sales Forecast/net_revenue_retention_all_customers.sql - Source NRR query
/Users/deucethevenowworkm1/Projects/Sales Forecast/cohort_retention_matrix.sql - Source cohort matrix query
```

## üîß ENVIRONMENT
- Working directory: `/Users/deucethevenowworkm1/Projects/company-kpi-dashboard`
- Required: `GOOGLE_APPLICATION_CREDENTIALS="/Users/deucethevenowworkm1/.config/bigquery-mcp-key.json"`
- BigQuery project: `stitchdata-384118`
- BigQuery dataset: `App_KPI_Dashboard`
- Data sources: `src_fivetran_qbo.*`, `src_fivetran_hubspot.*`

## üí° NEXT SESSION SHOULD

1. **First action**: Views are complete - check if GMV views need same spine fix
2. **Suggested approach**: Run validation queries periodically to monitor variance
3. **Things to verify**: New transactions appearing in correct periods
4. **Pitfalls to avoid**: Don't modify spine logic without understanding period attribution impact

## üìù CRITICAL VERBATIM CONTEXT

### Net Revenue Formula:
```
Invoice Line Amount (accounts 4000-4190)
+ Credit Memos (negative)
+ Organizer Fees/Bills (accounts 4200-4240, negative)
+ Vendor Credits (accounts 4200-4240, positive)
= NET REVENUE
```

### P&L Expected Totals:
- 2024 Net Revenue: $4,333,451.22
- 2025 Net Revenue: $3,911,537.48

### User Clarification on Period Attribution:
"this should put invoices and credit memos in the period in which they were created, it shouldn't tie credit memos back to invoices that are not in the same period"

## üßµ CONVERSATION EVOLUTION
- **Original ask**: Continue NRR analysis from previous session, investigate class_name for attribution
- **How it evolved**: Deep investigation into variance ‚Üí discovered orphaned transaction issue ‚Üí implemented spine fix
- **Key decisions by user**:
  - Accepted ~0.5% variance as reasonable
  - Confirmed queries should be stored in `/company-kpi-dashboard/queries/customers/`
  - Confirmed both NRR tracker and cohort matrix needed the spine fix
